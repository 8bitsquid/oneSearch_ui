/*! oneSearch-ui 01-04-2015 */
function inArray(a,b){return b.indexOf(a)>-1}function isEmpty(a){if(null==a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0}function toArray(a){return Array.isArray(a)?a:Object.keys(a).map(function(b){return a[b]})}angular.module("oneSearch",["ngRoute","ngAnimate","ngSanitize","ui.bootstrap","angular.filter","oneSearch.common","oneSearch.templates","oneSearch.bento"]).constant("JSON_URL","https://wwwdev2.lib.ua.edu/oneSearch/getJSON.php").value("SearchParams",{pp:100}),angular.module("oneSearch.bento",[]).config(["$routeProvider",function(a){a.when("/bento/:s",{templateUrl:"bento/bento.tpl.html",controller:"BentoCtrl"})}]).service("Bento",["$routeParams","$filter","oneSearch","mediaTypes",function(a,b,c,d){function e(a,b){var c=g.boxes[a].engines.indexOf(b);-1!=c&&g.boxes[a].engines.splice(c,1)}function f(a){angular.forEach(g.boxes,function(b,c){e(c,a)})}var g=this;this.boxes={},this.engines={},this.getBoxes=function(){var h=c.searchAll(a);angular.copy(d.types,g.boxes),angular.forEach(g.boxes,function(a,b){var c=g.boxes[b].engines.length>1?1:3;g.boxes[b].results={},g.boxes[b].resultLimit=c}),angular.forEach(h,function(a,h){a.response.success(function(i){var j=a.getResults(i);if(isEmpty(j))f(h);else{var k=d.groupBy(j,a.mediaTypes);Object.keys(g.boxes).forEach(function(a){k.hasOwnProperty(a)&&(g.boxes[a].results[h]=b("limitTo")(k[a],3)),e(a,h)}),g.engines[h]={},g.engines[h].tpl=c.getEngineTemplate(a),g.engines[h].controller=c.getEngineController(a)}}).error(function(){f(h)})})}}]).controller("BentoCtrl",["$scope","Bento",function(a,b){a.$on("$routeChangeSuccess",function(){b.getBoxes()})}]).directive("bentoBox",["$rootScope","$controller","$compile","$animate","Bento",function(a,b,c,d,e){return{restrict:"A",link:function(f,g,h){function i(a){isEmpty(e.boxes[a].results)&&(h.hideIfEmpty?g.addClass("hidden"):(g.append("<strong>No Results</strong>"),g.addClass("text-muted"))),d.leave(k),m()}var j=h.bentoBox,k=angular.element('<div id="loading-bar-spinner"><div class="spinner-icon"></div></div>'),l=g.find("h2");d.enter(k,l,angular.element(l[0].lastChild));var m=f.$watch(function(){return e.boxes[j].engines},function(d,f){if(d!==f){for(var h="",k=0,l=f.length;l>k;k++){var m=f[k];if(!(d.indexOf(m)>-1)){h=m;break}}var n=a.$new(!0);n.items=e.boxes[j].results[h],n.items&&n.items.length>0&&(n.isCollapsed=!0,e.engines[h].tpl.then(function(a){if(e.engines[h].controller){var d=b(e.engines[h].controller,{$scope:n});g.data("$ngControllerController",d),g.children().data("$ngControllerController",d)}var f=angular.element('<div class="animate-repeat bento-box-item" ng-repeat="item in items">'+a+"</div>"),i=c(f)(n);g.append(i)})),0==d.length&&i(j)}},!0)}}}]),angular.module("oneSearch.common",["common.mediaTypes","common.oneSearch","common.engines","filters.nameFilter"]),angular.module("oneSearch.common").factory("dataFactory",function(a){return{get:function(b){return a.get(b).then(function(a){return a.data})}}}).directive("suggestOneSearch",function(a){return{restrict:"AEC",scope:{prompt:"@",model:"=",search:"="},controller:function(a,b,c,d){a.items={},a.filteredItems=[],a.model="",a.current=-1,a.originalValue=a.model,a.dataRequested=!1,a.numShow=5,a.selected=!0,a.onChange=function(){var b=a.model.lastIndexOf(" ");a.selected=!1,(a.model.length-b<=3||a.model.indexOf(a.originalValue)<0)&&(a.items={},a.setCurrent(-1,!1),a.dataRequested=!1),a.model.length-b>3&&!a.dataRequested&&(d.get("//wwwdev2.lib.ua.edu/oneSearch/api/suggest/"+a.model).then(function(b){a.items.suggest=b,a.setCurrent(-1,!1)}),a.dataRequested=!0),a.model.length>2&&c(function(){d.get("//wwwdev2.lib.ua.edu/oneSearch/api/recommend/"+a.model).then(function(b){a.items.recommend=b}),d.get("//wwwdev2.lib.ua.edu/staffDir/api/subject/"+a.model+"/match/startwith").then(function(b){a.items.subjects=b}),d.get("//www.googleapis.com/customsearch/v1?key=AIzaSyCMGfdDaSfjqv5zYoS0mTJnOT3e9MURWkU&cx=003453353330912650815:lfyr_-azrxe&q="+a.model+"&siteSearch=ask.lib.ua.edu").then(function(b){a.items.faq=b})},200),a.originalValue=a.model},a.go=function(c){a.model="",a.originalValue=a.model,b.location.href=c},a.setCurrent=function(b,c){if(a.current=b,"undefined"!=typeof a.items.suggest)for(var d=0;d<a.items.suggest.length;d++)a.items.suggest[d]["class"]="";b>=0&&a.filteredItems.length>0&&(b>a.filteredItems.length-1&&(b=a.filteredItems.length-1),c&&(a.model=a.filteredItems[b].search),a.filteredItems[b]["class"]="active",a.current=b)},a.onFocus=function(){a.model.length>2&&(a.selected=!1)},a.onBlur=function(){a.selected=!0},a.compare=function(a){return function(b){return 0!=b.search.indexOf(a)||angular.equals(b.search.toLowerCase(),a.toLowerCase())?!1:!0}}},link:function(b,c){c.bind("keydown",function(a){switch(a.keyCode){case 38:b.current>0?(b.setCurrent(b.current-1,!0),a.preventDefault()):(b.setCurrent(-1,!1),b.model=b.originalValue,a.preventDefault());break;case 40:b.model.length>2&&b.current<b.numShow-1&&b.current<b.items.suggest.length-1&&(b.setCurrent(b.current+1,!0),a.preventDefault());break;case 13:b.selected=!0}b.$apply()}),b.handleSelection=function(c){a(function(){b.model=c,b.selected=!0,b.$apply(),b.search()},0)}},templateUrl:"common/directives/suggest/suggest.tpl.html"}}),angular.module("engines.acumen",[]).config(["oneSearchProvider",function(a){a.engine("acumen",{id:8,resultsPath:"Acumen.data",totalsPath:"Acumen.metadata.numFound",templateUrl:"common/engines/acumen/acumen.tpl.html",controller:function(a){for(var b=a.items,c=0,d=b.length;d>c;c++)b[c].type&&(b[c].type="text"==b[c].type[0]&&b[c].details.genre?b[c].details.genre.sort().shift():b[c].type.sort().shift())}})}]),angular.module("engines.catalog",[]).config(["oneSearchProvider",function(a){a.engine("catalog",{id:64,resultsPath:"Catalog.list",totalsPath:"Catalog.total",mediaTypes:{path:"bibFormat",types:{books:["aa","ac","ad","am"],journals:["ab","as","bb","bs","cb","cs","db","ds","eb","es","fb","fs","gb","gs","ib","is","jb","js","kb","ks","mb","ms","ob","os","pb","ps","rb","rs","tb","ts"],media:["ga","gc","gd","gm","ia","ic","id","im","ja","jc","jd","jm"]}},templateUrl:"common/engines/catalog/catalog.tpl.html",controller:function(a,b){for(var c={bc:"Archive/Manuscript",cm:"Music Score",em:"Map",im:"Nonmusical Recording",jm:"Musical Recording",mm:"Computer File/Software",om:"Kit",pc:"Mixed Material/Collection",pm:"Mixed Material",rm:"Visual Material"},d=a.items,e=0;e<d.length;e++){var f=d[e].bibFormat;if(d[e].mediaType=c[f],!d[e].author){var g=b("catalogSplitTitleAuthor")(d[e].title);angular.isArray(g)&&(d[e].title=g[0],d[e].author=g[2])}}a.items=d}})}]).filter("catalogSplitTitleAuthor",[function(){return function(a){if(a.indexOf("/")>-1){var b=a.split(/\s\/\sedited\sby\s([^.+]+)\./);a=b}return a}}]),angular.module("engines.databases",[]).config(["oneSearchProvider",function(a){a.engine("databases",{id:2,resultsPath:"Databases.results",totalsPath:"Databases.total",templateUrl:"common/engines/databases/databases.tpl.html"})}]),angular.module("engines.ejournals",[]).config(["oneSearchProvider",function(a){a.engine("ejournals",{id:4,resultsPath:"eJournals.results",totalsPath:"eJournals.total",mediaTypes:{path:"type",types:{books:"book",journals:"periodical"}},templateUrl:"common/engines/ejournals/ejournals.tpl.html",controller:["$scope",function(a){for(var b=0,c=a.items.length;c>b;b++);}]})}]),angular.module("common.engines",["engines.acumen","engines.catalog","engines.databases","engines.scout","engines.googleCS","engines.faq","engines.libguides","engines.ejournals","engines.recommend"]).service("enginesTemplateFactory",["$http","$templateCache",function(a,b){this.get=function(a){return angular.isDefined(a.templateUrl)?this.fromUrl(a.templateUrl):null},this.fromUrl=function(c){return null==c?null:a.get(c,{cache:b,headers:{Accept:"text/html"}}).then(function(a){return a.data})}}]),angular.module("engines.faq",[]).config(["oneSearchProvider",function(a){a.engine("faq",{id:16,resultsPath:"GoogleCS.items",totalsPath:"GoogleCS.searchInformation.totalResults",filterQuery:"site:ask.lib.ua.edu",templateUrl:"common/engines/google-cs/google-cs.tpl.html"})}]),angular.module("engines.googleCS",[]).config(["oneSearchProvider",function(a){a.engine("googleCS",{id:16,resultsPath:"GoogleCS.items",totalsPath:"GoogleCS.searchInformation.totalResults",filterQuery:"-side:guides.lib.ua.edu -site:ask.lib.ua.edu",templateUrl:"common/engines/google-cs/google-cs.tpl.html"})}]),angular.module("engines.libguides",[]).config(["oneSearchProvider",function(a){a.engine("libguides",{id:16,resultsPath:"GoogleCS.items",totalsPath:"GoogleCS.searchInformation.totalResults",filterQuery:"site:guides.lib.ua.edu",templateUrl:"common/engines/libguides/libguides.tpl.html"})}]),angular.module("engines.recommend",[]).config(["oneSearchProvider",function(a){a.engine("recommend",{id:512,resultsPath:"Recommendations",templateUrl:"common/engines/recommend/recommend.tpl.html"})}]),angular.module("engines.scout",[]).config(["oneSearchProvider",function(a){a.engine("scout",{id:1,resultsPath:"Scout.SearchResult.Data.Records",totalsPath:"Scout.SearchResult.Statistics.TotalHits",mediaTypes:{path:"Header.PubTypeId",types:{books:["book","ebook"],articles:"academicJournal",media:["audio","videoRecording"]}},templateUrl:"common/engines/scout/scout.tpl.html",controller:function(a){for(var b=a.items,c=0;c<b.length;c++){"audio"==b[c].Header.PubTypeId&&(b[c].mediaType="Audio"),"videoRecording"==b[c].Header.PubTypeId&&(b[c].mediaType="Video Recording");for(var d=0;d<b[c].Items.length;d++)"Src"==b[c].Items[d].Group&&(b[c].source=b[c].Items[d].Data)}a.items=b}})}]),angular.module("filters.nameFilter",[]).filter("nameFilter",["$filter",function(){return function(a){if(a.indexOf(",")>-1){var b=a.split(",");a=b.map(function(a){return a.trim()}).reverse().join(" ")}return a}}]);var invertArrayToObject=function(a){var b={};return Object.keys(a).map(function(c){for(var d=0,e=a[c].length;e>d;d++)b[a[c][d]]=c}),b},hasOwnProperty=Object.prototype.hasOwnProperty;angular.module("common.mediaTypes",[]).provider("mediaTypes",[function(){function a(a){var b={};return angular.forEach(a,function(a,c){var d={};switch(typeof a){case"string":case"number":a=[a];break;case"object":a=toArray(a)}d[c]=a,d=invertArrayToObject(d),angular.extend(b,d)}),b}var b={other:{engines:[],loaded:!1}};this.type=function(a,c){b[a]||(b[a]={engines:[],loaded:!1}),b.other.engines.indexOf(c)>-1||b.other.engines.push(c),b[a].engines.push(c)},this.$get=["$parse",function(c){return{types:b,groupBy:function(b,d){var e={};if(angular.isObject(d)){var f,g,h=a(d.types),i=c(d.path);angular.forEach(b,function(a){f=i(a),g=h[f],angular.isUndefined(g)?(e.other||(e.other=[]),e.other.push(a)):(e[g]||(e[g]=[]),e[g].push(a))})}else e[d]=b;return e}}}]}]),angular.module("common.oneSearch",[]).provider("oneSearch",["mediaTypesProvider",function(a){var b={};this.engine=function(c,d){if(angular.isString(c)){var e={id:null,resultsPath:null,totalsPath:null,mediaTypes:null,templateUrl:null,filterQuery:null,controller:null},f=angular.extend(e,d);f.id&&(f.mediaTypes?Object.keys(f.mediaTypes.types).map(function(b){a.type(b,c)}):(a.type(c,c),f.mediaTypes=c),f.name=c,b[c]=f)}else console.log({Error:"oneSearch engine must have STRING defined name",engineParams:d})},this.$get=["$http","$parse","enginesTemplateFactory","SearchParams","JSON_URL",function(a,c,d,e,f){return{engines:b,searchAll:function(d){return angular.extend(d,e),angular.forEach(b,function(e,g){var h={engine:e.id};angular.extend(h,d),null!==e.filterQuery&&(h.s+=" "+e.filterQuery),e.response=a({method:"GET",url:f,params:h}),angular.isDefined(e.resultsPath)&&(e.getResults=c(e.resultsPath)),angular.isDefined(e.totalsPath)&&(e.getTotal=c(e.totalsPath)),b[g]=e}),b},getEngineTemplate:function(a){return d.get(a)},getEngineController:function(a){return angular.isDefined(a.controller)?a.controller:null}}}]}]).controller("OneSearchCtrl",["$scope","$location","$rootScope",function(a,b,c){a.searchText,a.search=function(){a.searchText&&b.path("/bento/"+a.searchText)},c.$on("$routeChangeSuccess",function(b,c){var d=c.params.s;a.searchText!==d&&(a.searchText=d)})}]);